name: Redot Build Release
on:
  workflow_dispatch:
    inputs:
      build-type:
        description: "What type of build"
        required: true
        type: choice
        default: all
        options:
          - all
          - linux
          - windows
          - osx
          - ios
          - web
          - android
      version:
        description: "What version to build"
        required: true
        type: string
        default: "4.3-beta.3"
      git-tag:
        description: "What tag or branch to use form redot engine"
        required: true
        type: string
        default: "redot-4.3-beta.3"
      container-tag:
        description: "Build container tag"
        required: true
        type: string
        default: "4.3-40"

# Global Settings
# SCONS_CACHE for windows must be set in the build environment
# TODO move mono builds to Redot ones
env:
  REDOT_BASE_VERSION_STATUS: stable
  REDOT_BASE_VERSION: ${{ github.event.inputs.version }}
  REDOT_BASENAME: Redot_v${{ github.event.inputs.version }}
  REDOT_VERSION_STATUS: custom
  REDOT_MONO_BUILD_TAG: release-4912f62 # mono-6.12.0.198
  REDOT_MONO_BUILD_REPO: godotengine/godot-mono-builds
  BUILD_NAME: official


jobs:
  tarball:
    runs-on: [self-hosted]
    env:
      REDOT_VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create source cache
        id: source-cache
        uses: actions/cache@v4
        with:
          path: redot-engine
          key: redot-engine-${{env.REDOT_BASE_VERSION}}
          restore-keys: |
            redot-engine-${{env.REDOT_BASE_VERSION}}

      - name: Checkout Redot source
        if: steps.source-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: Redot-Engine/redot-engine
          fetch-tags: true
          ref: ${{ github.event.inputs.git-tag }}
          path: redot-engine

      - name: Setup deps
        if: steps.source-cache.outputs.cache-hit != 'true'
        uses: ./.github/actions/build-deps
        with:
          working: "redot-engine"

      - name: Validate and Tarball
        if: steps.source-cache.outputs.cache-hit != 'true'
        working-directory: redot-engine
        shell: bash
        run: |
          cp ../check_version.py .
          correct_version=$(python3 check_version.py)

          if [[ "$correct_version" != "True" ]]; then
            echo "Version in version.py doesn't match the passed ${{ github.event.inputs.version }}."
            exit 1
          fi

          sh misc/scripts/make_tarball.sh -v ${{ github.event.inputs.version }}
          cp ../redot-${{ github.event.inputs.version }}.tar.gz .


  mono-glue:
    needs: tarball
    runs-on: [self-hosted]
    container:
      image: ghcr.io/trashguy/redot-linux:${{ github.event.inputs.container-tag }}
    env:
      SCONS: scons  verbose=yes warnings=no progress=no
      OPTIONS: debug_symbols=no use_static_cpp=no
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get source cache
        uses: actions/cache/restore@v4
        with:
          path: redot-engine
          key: redot-engine-${{env.REDOT_BASE_VERSION}}
          restore-keys: |
            redot-engine-${{env.REDOT_BASE_VERSION}}

      - name: Mono cache
        uses: actions/cache@v4
        id: mono-cache
        with:
          path: redot-engine/mono-glue
          key: redot-engine-mono-${{env.REDOT_BASE_VERSION}}
          restore-keys: |
            redot-engine-mono-${{env.REDOT_BASE_VERSION}}

      - name: Build mono glue
        if: steps.mono-cache.outputs.cache-hit != 'true'
        shell: bash
        working-directory: redot-engine
        run: |
          export PATH="${GODOT_SDK_LINUX_X86_64}/bin:${BASE_PATH}"
          echo "Building and generating Mono glue..."
          dotnet --info
          ${SCONS} platform=linuxbsd ${OPTIONS} target=editor module_mono_enabled=yes
          bin/redot.linuxbsd.editor.x86_64.mono --headless --generate-mono-glue mono-glue

  linux:
    name: Linux ${{ matrix.name }}
    needs: mono-glue
    runs-on: [self-hosted]
    container:
      image: ghcr.io/trashguy/redot-linux:${{ github.event.inputs.container-tag }}
    env:
      SCONS: scons  verbose=yes warnings=no progress=no
      OPTIONS: production=yes
      OPTIONS_MONO: module_mono_enabled=yes
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - name: Editor & Templates
            cache-name: linux
            build-mono: false
          - name: Editor & Templates w/ Mono
            cache-name: linux-mono
            build-mono: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get source cache
        uses: actions/cache/restore@v4
        with:
          path: redot-engine
          key: redot-engine-${{env.REDOT_BASE_VERSION}}
          restore-keys: |
            redot-engine-${{env.REDOT_BASE_VERSION}}

      - name: Mono cache
        uses: actions/cache/restore@v4
        with:
          path: redot-engine/mono-glue
          key: redot-engine-mono-${{env.REDOT_BASE_VERSION}}
          restore-keys: |
            redot-engine-mono-${{env.REDOT_BASE_VERSION}}

      - name: Setup Redot build cache
        uses: ./.github/actions/scons-cache
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: Build Linux Editor and Templates
        uses: ./.github/actions/build-linux
        with:
          mono: ${{ matrix.build-mono }}

  build-release-linux:
    name: Build Release Linux
    needs: linux
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Linux Release
        uses: ./.github/actions/build-release-linux
